<!doctype html>
<html>
  <head>
    <meta charset=utf-8/>
    <title>fext.js: Fast Explicit Tail Calls</title>
    <link rel="stylesheet" type="text/css" href="web/prettify.css">
    <style type="text/css">
      body {
      padding: 0 1em 0 1em;
      font-family: helvetica; 
      font-family: Verdana,Arial,'Lucida Grande',Sans-Serif;
      }
      .title { margin-bottom: 1em; }
      .right { float: right; }
      .text-center { text-align: center; }

      .intro { margin: auto; max-width: 600px; text-align: justify;}

      .top-img { text-align: center; }
      @media screen and (min-width: 1200px) {
      .top-img { float: left; }
      }
      
      .hidden { display: none; }
      .small_img { max-width: 6em; margin: 0.5em; }
      .code_cont { 
      float: left;
      position: relative;
      width: calc( 100% - 2em );
      padding: 1em;
      }
      
      @media screen and (min-width: 1200px) {
      .code_cont {
      width: calc( 50% - 2em );
      }
      }
      .code_cont_header {
      margin-top: 2em;
      background-color: lightgrey;
      border: solid 1px black;
      padding: 1em;
      }
      .code_o { width: 100%; margin: 0; max-height: 100%; }
      .code_o.fext_unittest_js { height: 65em; }
      .code_o.fext_js { height: 435em; }

      .success { color: darkgreen; }
      .failure { color: darkred; font-weight: bold;}

      .speedtest_patience { display: none; }
      .speedtest_running .speedtest_patience { display: inherit; }
      .speedtest_running button { display: none; }
    </style>
    </head>
  <body>

    <div class="intro">
      
    <div class="top-img"><img class="small_img" src="web/serpent-mord-queue-2.jpg"/></div>

    <h1 class="title"><code>fext.js</code>: Fast Explicit Tail Calls</h1>


    <div class="right">by <a href="../">G. Lathoud</a>, June 2018.</div>

    <p>...using today&#39;s JavaScript!</p>

      <p>Usually, tail calls are automatically optimized (LISP...).</p> <p>In JavaScript, programmers may well not know which "return" statements are optimized by the engine, and which not. This would lead to practical issues when debugging/optimizing (<a href="http://neopythonic.blogspot.de/2009/04/final-words-on-tail-calls.html">2009</a>).</p>
      
      <p>As of 2018, progress is "slow" and the Chrome team has already <em>removed</em> the automatic self-recursion optimization from its JavaScript engine.</p>
      
      <p>Another possibility is to <strong>explicitly mark the tail calls that will be optimized</strong>.  JavaScript extensions were proposed that add new keywords to the language (<a href="http://glat.info/js.metaret/">2013</a>,&nbsp;<a href="https://github.com/tc39/proposal-ptc-syntax">2016</a>).</p>
      
      <p>It turns out that we can do this explicit approach using today's JavaScript, without extending the language.
        
      <code>fext.js</code> demonstrates this. Mutual recursion is supported.</p>

      <h3>Quick example</h3>

      <pre><code class="prettyprint lang-js">&lt;script type="text/javascript" src="fext.js"&gt;&lt;/script&gt
&lt;script type="text/javascript"&gt;
  var gcd = mfun(
         (a, b) => a > b  ?  mret( self, a-b, b )
             :     a < b  ?  mret( self, b-a, a )
             :     a
  );
  console.log( gcd( 2*3*5*17, 3*5*19 ) );  // 15 (3*5)
&lt;/script&gt;</code></pre>
      
      <h3>API Documentation</h3>

    <p>README.md on <a href="https://github.com/glathoud/fext#api">GitHub</a> (formatted), or directly <a href="README.md">here</a> (unformatted).</p>

    <h3>Speed test</h3>

    <section id="speedtest_section">
      
      <pre><code id="speedtest_output"></code></pre>
      
      <p>
        <button onclick="fext_speedtest(speedtest_section,speedtest_output)">Run</button>
        <span class="speedtest_patience">Running (please be patient...)</span>

      </p>

    </section>
    
    <h3>Unit tests</h3>
    <pre><code id="unittest_output">Running...</code></pre>

    
    <section>
      <h3>Code</h3>

      <p>On <a href="https://github.com/glathoud/fext/">GitHub</a> and here below:</p>
      <div id="toccont">
        <ul id="toc"></ul>
      </div>
      
    </section>

    </div>

    
    <div id="source_code_0" class="code_cont"></div>
    <div id="source_code_1" class="code_cont"></div>
    
    <script type="text/html" id="source_code_tmpl">
    <p class="code_cont_header" id="$domid">$filename:</p>
    <pre><code class="prettyprint lang-js">$sourcecode</code></pre>
    </script>
    
    <script type="text/html" id="toctmpl">
    <li><a href="#$domid">$filename</a></li>
    </script>
    
    <script type="text/javascript" src="fext.js"></script>
    <script type="text/javascript" src="lib/sorted_search.js"></script>

    <script type="text/javascript" src="lib/sorted_search_unittest.js"></script>
    <script type="text/javascript" src="test/fext_unittest.js"></script>
    <script type="text/javascript" src="test/fext_unittest_es6.js"></script>

    <script type="text/javascript" src="web/prettify.js"></script>
    <script type="text/javascript">
    (function () {
        
        var cstmpl = source_code_tmpl;
        cstmpl.parentNode.removeChild( cstmpl );

        toccont.style.display = 'none';
        write_source_code( source_code_0, get_test_arr_es6, "ES6 unit tests" );
        write_source_code( source_code_0, get_test_arr_es5, "ES5 unit tests" );
        write_source_code( source_code_1, "fext.js" )
        write_source_code( source_code_1, "lib/sorted_search.js" )
        write_source_code( source_code_1, get_test_arr_sorted_search, "lib/sorted_search.js: unit tests" );

        function write_source_code( contnode, x, opt )
        {
            write_source_code.n = 1 + (write_source_code.n | 0);

            if ('function' === typeof x)
            {
                var filename = opt  ||  x.name
                ,   c_arr    = x().map( unindent )
                ;
                setTimeout( function () {
                    receive_source_code(
                        {
                            target : {
                                responseText : c_arr.join( '\n\n\n' )
                            }
                        }
                    );
                }, 100 );
            }
            else
            {
                var filename = x
                ,   xhr = new XMLHttpRequest()
                ;
                try {
                    xhr.addEventListener( "load", receive_source_code );
                    xhr.open( "GET", filename, /*async:*/true );
                    xhr.send();
                } finally {
                    write_source_code.n--;
                }
            }

            if (toc  &&  toctmpl)
            {
                toc.innerHTML += format(
                    toctmpl.innerHTML, filename
                );
            }
            
            function unindent( f )
            {
                var   s = '' + f
                , first = /\n\s+/.exec( s )
                ;
                return first
                    ?  s.replace( new RegExp( first[ 0 ], 'g' )
                                  , '\n'
                                )
                    : s;
            }
            
            function receive_source_code( a )
            {
                var et = a  &&  a.target
                ,   etr = et  &&  (et.response || et.responseText)
                ,   domid = filename.replace(/\W/g,'_')
                ;
                contnode.innerHTML += format( 
                    cstmpl.innerHTML, filename, etr
                );

                if (--write_source_code.n < 1)
                {
                    prettyPrint();
                    toccont.style.display = '';
                    setTimeout( do_the_unittests, 2000 );
                }
            }
        }

        function format( tmpl, filename, sourcecode )
        {
            var domid = filename.replace(/\W/g,'_')
            ,   ret   = tmpl
                .replace( /\$filename\b/g, filename)
                .replace( /\$domid\b/g, domid )
            ;
            if (sourcecode)
            {
                ret = ret.replace( /\$sourcecode\b/g
                                   , sourcecode
                                   .replace( /</g, '&lt;' )
                                   .replace( />/g, '&gt;' )
                                 );
            }
            return ret;
        }

        function do_the_unittests()
        {
            fext_unittest(
                function ( result )
                {
                    unittest_output.innerHTML = result.text.replace( /^\s+/, '' );
                }
            );
        }
    })();
    </script>

    <script type="text/javascript" src="test/fext_speedtest.js"></script>

    <script type="text/javascript" src="web/ga.js"></script>
  </body>
</html>
